# IECC2 架构设计

## 概述

IECC2 是使用 Go 编写的完整 IEC 61131-3 PLC 开发工具链，面向工业控制器上的 ANSI C 输出部署。系统包括多语言编译器、VS Code IDE 扩展、调试适配器、仿真器和可移植运行时。

## 编译流水线

```
Source (.st / .il / .fbd.json / .ld.json / .sfc.json)
  │
  ▼
┌────────────────────────────────────────────────┐
│  Lexer  (ANTLR4 — IEC61131Lexer.g4)           │
│  → Token Stream                                │
└────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────┐
│  Parser  (ANTLR4 — IEC61131Parser.g4)          │
│  → Concrete Syntax Tree (Parse Tree)           │
└────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────┐
│  AST Builder  (pkg/astbuilder)                 │
│  → Typed Abstract Syntax Tree (ast.SourceFile) │
└────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────┐
│  Semantic Analysis  (pkg/semantic)             │
│  → Symbol table, type checking, scope          │
└────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────┐
│  IR Generation  (pkg/irgen)                    │
│  → Three-Address Code (ir.Program)             │
│    - ST lowering (lower.go)                    │
│    - SFC state machine (sfc_lower.go)          │
│    - IL instruction mapping (il_lower.go)      │
└────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────┐
│  IR Optimization  (pkg/iropt)                  │
│  → Dead code elimination, constant folding,    │
│    copy propagation, alias analysis, PGO       │
└────────────────────────────────────────────────┘
  │
  ▼
┌──────────────┬──────────────┬──────────────────┐
│  C Backend   │ LLVM Backend │  WASM Backend    │
│ (pkg/codegen)│(pkg/llvmgen) │ (pkg/wasmgen)    │
│  → .c file   │  → .ll file  │  → .wat file     │
└──────────────┴──────────────┴──────────────────┘
  │
  ▼
  GCC / Clang / wat2wasm → Native Binary / Wasm Module
```

（源文件 → 词法分析 → 语法分析 → AST 构建 → 语义分析 → IR 生成 → IR 优化 → C/LLVM/WASM 后端 → 原生二进制/Wasm 模块）

## 包映射

| 包 | 用途 |
|---------|---------|
| `pkg/parser` | ANTLR4 生成的词法分析器/解析器（Go visitor 模式） |
| `pkg/ast` | 类型化 AST 节点定义（50+ 节点类型） |
| `pkg/astbuilder` | 解析树 → AST 转换 |
| `pkg/semantic` | 符号表、类型检查、作用域解析 |
| `pkg/types` | 类型系统（基本类型、数组、结构体、枚举、REF_TO、FB） |
| `pkg/ir` | 三地址码 IR 数据结构 |
| `pkg/irgen` | ST、IL、SFC 的 AST → IR lowering |
| `pkg/iropt` | IR 优化遍 |
| `pkg/codegen` | IR → ANSI C 代码发射器 |
| `pkg/llvmgen` | IR → LLVM IR 发射器 |
| `pkg/wasmgen` | IR → WebAssembly 文本发射器 |
| `pkg/lsp` | 语言服务器协议实现 |
| `pkg/dap` | 调试适配器协议实现 |
| `pkg/interp` | 用于仿真/调试的 IR 解释器 |
| `pkg/graphlang` | FBD/LD 的文本表示 |
| `pkg/docgen` | ST → Markdown API 文档生成器 |
| `pkg/compiler` | 高层编译协调器 |
| `pkg/diagnostic` | 错误/警告诊断收集 |
| `pkg/symbols` | 符号表数据结构 |
| `pkg/cache` | 增量编译缓存 |
| `pkg/opcua` | OPC UA NodeSet XML 生成器 |
| `pkg/runtime` | 运行时配置类型 |

## 命令行工具

| 命令 | 说明 |
|---------|-------------|
| `iecc` | 编译器 CLI — 将 ST/IL 编译为 C/LLVM/WASM |
| `iec-lsp` | 语言服务器，用于 VS Code 集成 |
| `iec-dap` | 调试适配器，用于单步调试与仿真 |
| `iec-sim` | 带 WebSocket API 的独立仿真器 |

## 运行时架构

```
┌─────────────────────────────────────────────┐
│  User PLC Program  (compiled C)             │
├─────────────────────────────────────────────┤
│  IEC Standard Library  (iec_stdlib.h)       │
│  TON, TOF, CTU, R_TRIG, CONCAT, LEN ...    │
├─────────────────────────────────────────────┤
│  Runtime Core  (iec_runtime.h)              │
│  Task scheduling, retain variables          │
├─────────────────────────────────────────────┤
│  Communication  (iec_modbus.c, iec_opcua.c) │
│  Modbus TCP/RTU, OPC UA Server/Client       │
├─────────────────────────────────────────────┤
│  HAL  (iec_platform.h)                      │
│  POSIX, Linux GPIO, timer, I/O mapping      │
└─────────────────────────────────────────────┘
```

（用户 PLC 程序 → IEC 标准库 → 运行时核心 → 通信 → HAL）

## VS Code 扩展架构

```
┌────────────────────────────────────────────────┐
│  VS Code Extension Host  (TypeScript)          │
│  ├─ Language client (LSP)                      │
│  ├─ Debug client (DAP)                         │
│  ├─ Custom editors (FBD, LD, SFC, HMI, ...)   │
│  ├─ Project tree provider (CODESYS-style)      │
│  ├─ Build task provider                        │
│  └─ Binary resolver (zero-config toolchain)    │
├────────────────────────────────────────────────┤
│  Webview Apps  (React 18 + React Flow)         │
│  15 webview panels:                            │
│  fbd, ld, sfc, var-table, monitor,             │
│  hmi, task-config, build-config, force-table,  │
│  trace, library-manager, device-selector,      │
│  io-config, alarm, recipe                      │
├────────────────────────────────────────────────┤
│  Go Backend Processes                          │
│  ├─ iec-lsp (Language Server)                  │
│  ├─ iec-dap (Debug Adapter)                    │
│  └─ iecc    (Compiler)                         │
└────────────────────────────────────────────────┘
```

（VS Code 扩展宿主 → Webview 应用 → Go 后端进程）

## IEC 61131-3 语言支持

| 语言 | 状态 | 实现方式 |
|----------|--------|---------------|
| Structured Text (ST) | 完整 | Parser → AST → IR → C/LLVM/WASM |
| Instruction List (IL) | 完整 | Parser → AST → IR → C/LLVM/WASM |
| Sequential Function Chart (SFC) | 完整 | Parser → AST → 状态机 IR |
| Function Block Diagram (FBD) | 图形化 | JSON → Graphlang → AST |
| Ladder Diagram (LD) | 图形化 | JSON → Graphlang → AST |
| Configuration/Resource/Task | 完整 | Parser → AST → IR |

## 类型系统

完整支持 IEC 61131-3 基本类型、用户自定义类型和 OOP：

- **基本类型**：BOOL, SINT..LINT, USINT..ULINT, REAL/LREAL, STRING/WSTRING,
  TIME/DATE/TOD/DT, BYTE/WORD/DWORD/LWORD
- **结构类型**：STRUCT, UNION, ARRAY（多维）, ENUM, SUBRANGE
- **指针**：REF_TO 及解引用
- **OOP**：CLASS, INTERFACE, METHOD, PROPERTY 及访问修饰符
- **STRING[n]**：固定长度字符串，带 MaxLen 跟踪

## 测试策略

- **单元测试**：按包（30 个测试文件，25+ 包）
- **E2E 测试**：从源码到所有后端的完整流水线
- **解析器测试**：141 个样本，100% 通过率
- **Webview 测试**：Vitest + React Testing Library
- **模糊测试**：Go 原生模糊测试，用于解析器健壮性
