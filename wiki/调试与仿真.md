# 调试与仿真

本教程介绍 IECC2 提供的多种调试与仿真手段，包括虚拟 PLC（VPLC）、仿真器、DAP 断点调试，以及各类在线监控面板。你无需真实 PLC 硬件即可完成程序的验证与调试。

## 目录

- [前置要求](#前置要求)
- [调试方式概览](#调试方式概览)
- [VPLC 虚拟 PLC](#vplc-虚拟-plc)
- [仿真器 iec-sim](#仿真器-iec-sim)
- [DAP 断点调试](#dap-断点调试)
- [在线监控面板](#在线监控面板)
- [信号发生器与故障注入](#信号发生器与故障注入)
- [常见问题](#常见问题)

---

## 前置要求

- 已完成 [第一个 PLC 项目](第一个-PLC-项目.md)，有一个可编译的 ST 项目
- VS Code 中已安装 IEC 61131-3 PLC IDE 扩展

---

## 调试方式概览

IECC2 提供三种互补的调试/仿真方式：

| 方式 | 特点 | 适用场景 |
|------|------|----------|
| **VPLC 虚拟 PLC** | 完整的虚拟 PLC 引擎，模拟 I/O、任务调度、通信协议 | 系统级仿真、I/O 测试、协议联调 |
| **iec-sim 仿真器** | 轻量级 IR 解释器，快速执行程序逻辑 | 算法验证、快速调试 |
| **DAP 调试器** | VS Code 集成断点调试，单步执行、变量查看 | 逻辑调试、定位 bug |

```
┌──────────────────────────────────────────────────┐
│                   VS Code IDE                     │
│                                                   │
│  ┌─────────┐  ┌──────────┐  ┌─────────────────┐  │
│  │ ST 编辑器│  │ Monitor  │  │  Variable Table │  │
│  │         │  │  面板     │  │      面板       │  │
│  └────┬────┘  └────┬─────┘  └────────┬────────┘  │
│       │            │                  │           │
│       └────────────┼──────────────────┘           │
│                    │                              │
├────────────────────┼──────────────────────────────┤
│                    ▼                              │
│  ┌─────────────────────────────────────────────┐  │
│  │              VPLC Engine                     │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────────┐ │  │
│  │  │Scheduler │ │ I/O Buf  │ │ Modbus/OPCUA │ │  │
│  │  │(任务调度) │ │ (I/O缓冲)│ │  (通信协议)   │ │  │
│  │  └──────────┘ └──────────┘ └──────────────┘ │  │
│  └─────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
```

---

## VPLC 虚拟 PLC

VPLC 是一个功能完整的虚拟 PLC 引擎，模拟真实 PLC 的运行环境。

### 自动启动

默认情况下，VPLC 会随扩展自动启动（由 `iec-st.vplcAutoStart` 设置控制）。你可以在状态栏看到 VPLC 的运行状态。

### 手动管理 VPLC

| 操作 | 方式 |
|------|------|
| 启动 VPLC | 命令面板 → `IEC: VPLC Start` |
| 停止 VPLC | 命令面板 → `IEC: VPLC Stop` |
| 打开仪表盘 | 命令面板 → `IEC: VPLC Dashboard` |
| 打开配置 | 命令面板 → `IEC: VPLC Config` |
| 查看 I/O | 命令面板 → `IEC: VPLC I/O Panel` |
| 查看状态 | 命令面板 → `IEC: VPLC Status` |

### VPLC 配置文件

VPLC 使用 `.vplc.json` 配置文件。可以通过命令行生成默认配置：

```bash
iec-vplc init
```

生成的配置文件示例：

```json
{
  "name": "VirtualPLC",
  "cpu": {
    "model": "VPLC-1000",
    "cycleTimeUs": 1000,
    "maxTasks": 16,
    "programMemoryKB": 4096,
    "dataMemoryKB": 2048,
    "retainMemoryKB": 64,
    "watchdogMs": 500
  },
  "io": {
    "modules": [
      { "name": "DI-0", "type": "DI", "channels": 16, "startAddress": "%IX0.0" },
      { "name": "DO-0", "type": "DO", "channels": 16, "startAddress": "%QX0.0" },
      { "name": "AI-0", "type": "AI", "channels": 8, "startAddress": "%IW0", "range": "4-20mA" },
      { "name": "AO-0", "type": "AO", "channels": 4, "startAddress": "%QW0", "range": "0-10V" }
    ]
  },
  "communication": {
    "modbus": { "enabled": true, "port": 502, "slaveId": 1 },
    "opcua": { "enabled": true, "port": 4840 }
  },
  "simulation": {
    "signals": [
      { "channel": "%IX0.0", "generator": "pulse", "onMs": 1000, "offMs": 1000 },
      { "channel": "%IW0", "generator": "sine", "amplitude": 10000, "offset": 15000, "periodMs": 5000 }
    ]
  },
  "gateway": { "address": "127.0.0.1", "port": 4840 },
  "websocket": { "port": 8090 }
}
```

#### 配置项说明

| 配置块 | 说明 |
|--------|------|
| `cpu` | CPU 参数：扫描周期、最大任务数、内存分配、看门狗超时 |
| `io.modules` | I/O 模块定义：类型（DI/DO/AI/AO）、通道数、起始地址、量程 |
| `communication` | 通信协议：Modbus TCP 从站、OPC UA 模拟服务 |
| `simulation.signals` | 信号发生器：为输入通道自动生成模拟信号 |
| `gateway` | Gateway 连接参数 |
| `websocket` | WebSocket 监控端口 |

### VPLC 仪表盘

打开 VPLC Dashboard（命令面板 → `IEC: VPLC Dashboard`），你可以看到：

- **PLC 状态**：Idle / Running / Stopped / Paused / Error
- **任务执行统计**：周期时间、最大执行时间、超时次数
- **I/O 状态**：所有数字量/模拟量输入输出的实时值
- **诊断日志**：系统事件、错误信息、状态变更记录

### VPLC I/O 面板

打开 VPLC I/O Panel（命令面板 → `IEC: VPLC I/O Panel`），你可以：

- 查看所有 I/O 通道的实时值
- 手动设置输入值以模拟传感器
- 查看输出值以验证程序逻辑
- 数字量显示为开/关状态
- 模拟量显示数值和工程量转换值

### VPLC 服务模式

在命令行中启动 VPLC 服务模式：

```bash
# 默认配置启动
iec-vplc serve

# 指定配置文件和端口
iec-vplc serve --config my-plc.vplc.json --ws-port 8091

# 启动时加载程序
iec-vplc serve --program dist/program.so

# 禁用 Gateway 连接
iec-vplc serve --no-gateway
```

服务启动后，VS Code 扩展会自动连接并显示状态。

---

## 仿真器 iec-sim

`iec-sim` 是一个轻量级的仿真器，直接解释执行 IR（中间代码），适合快速验证程序逻辑。

### 基本用法

```bash
# 执行程序并打印每个周期的变量值
iec-sim -cycle 100 -vars Counter.st
```

输出示例：

```
[cycle 1] count=1, limit=100, running=TRUE, direction=TRUE
[cycle 2] count=2, limit=100, running=TRUE, direction=TRUE
...
[cycle 100] count=100, limit=100, running=TRUE, direction=FALSE
[cycle 101] count=99, limit=100, running=TRUE, direction=FALSE
```

### 常用选项

| 选项 | 说明 | 示例 |
|------|------|------|
| `-cycle <ms>` | 设置扫描周期（毫秒） | `-cycle 100` |
| `-max-cycles <n>` | 限制最大执行周期数 | `-max-cycles 1000` |
| `-vars` | 每个周期打印变量值 | `-vars` |
| `-ws <port>` | 启动 WebSocket 实时监控 | `-ws 8080` |
| `-entry <func>` | 指定入口函数名 | `-entry Main__body` |

### WebSocket 实时监控

```bash
iec-sim -cycle 100 -ws 8080 Counter.st
```

启动后，可以通过浏览器或 WebSocket 客户端连接 `ws://localhost:8080` 实时查看变量变化。

---

## DAP 断点调试

IECC2 集成了 DAP（Debug Adapter Protocol）调试器，支持在 VS Code 中进行断点调试。

### 配置 launch.json

1. 点击左侧 **运行和调试** 图标（或按 `Ctrl+Shift+D`）
2. 点击 **"创建 launch.json 文件"**
3. 选择 **"IEC 61131-3"** 环境
4. 生成的配置文件：

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "iec-st",
            "request": "launch",
            "name": "Debug PLC Program",
            "program": "${workspaceFolder}/MainProgram.st",
            "stopOnEntry": true
        }
    ]
}
```

| 配置项 | 说明 |
|--------|------|
| `type` | 固定为 `iec-st` |
| `program` | 主程序文件路径 |
| `stopOnEntry` | 是否在入口处暂停（`true` 方便检查初始状态） |

### 调试操作

1. 在 ST 文件中**点击行号左侧**设置断点（红色圆点）
2. 按 **F5** 启动调试
3. 程序会在断点处暂停

调试工具栏提供以下操作：

| 按键 | 操作 | 说明 |
|------|------|------|
| `F5` | 继续 | 运行到下一个断点 |
| `F10` | 单步跳过 | 执行当前行，不进入函数 |
| `F11` | 单步进入 | 进入函数/功能块内部 |
| `Shift+F11` | 单步跳出 | 从当前函数返回 |
| `Shift+F5` | 停止 | 结束调试会话 |

### 调试视图

调试期间，左侧面板显示：

- **变量（Variables）**：当前作用域内的所有变量及其值
- **监视（Watch）**：你添加的表达式监视
- **调用堆栈（Call Stack）**：当前执行位置
- **断点（Breakpoints）**：所有设置的断点列表

### 调试示例

假设你在调试 PID 控制器，想观察积分项的累积：

1. 打开 `PID_Controller.st`
2. 在积分计算行设置断点
3. 按 F5 启动调试
4. 每次命中断点时，在 Variables 面板查看 `integral`、`error`、`output` 等变量值
5. 在 Watch 面板添加表达式 `integral * ki` 观察积分输出

---

## 在线监控面板

IECC2 提供多种在线监控面板，覆盖不同的调试需求。

### 变量表（Variable Table）

打开方式：命令面板 → `IEC: Open Variable Table`

变量表是一个表格视图，展示项目中所有 POU 的变量：

| 功能 | 说明 |
|------|------|
| 变量列表 | 按 POU 分组显示所有变量 |
| 类型显示 | 显示每个变量的 IEC 数据类型 |
| 当前值 | 实时显示运行时变量值 |
| 修改值 | 双击可修改变量值（在线修改） |
| 搜索 | 按名称/类型过滤变量 |

### 在线监控（Monitor）

打开方式：命令面板 → `IEC: Open Monitor`

Monitor 面板实时显示变量值的变化：

- 按名称添加需要监控的变量
- 实时更新值（与 PLC 扫描周期同步）
- 高亮显示值发生变化的变量
- 支持布尔值、整数、浮点数、字符串等类型

### 强制表（Force Table）

打开方式：命令面板 → `IEC: Open Force Table`

强制表允许你临时覆盖变量的值，在每个扫描周期中持续生效：

| 功能 | 说明 |
|------|------|
| 添加强制变量 | 选择要强制的变量 |
| 设置强制值 | 指定强制写入的值 |
| 启用/禁用 | 单独控制每个变量的强制状态 |
| 全部释放 | 一键取消所有强制 |

**注意**：强制变量会覆盖程序逻辑的输出，仅用于测试和调试。

### 示波器/跟踪（Trace）

打开方式：命令面板 → `IEC: Open Trace`

Trace 面板以时间序列图的形式展示变量随时间的变化趋势：

- 添加多个变量到同一图表
- 设置采样间隔和记录时长
- 实时滚动显示波形
- 支持缩放和平移
- 导出跟踪数据

适用场景：
- 观察 PID 控制器的响应曲线
- 检测信号的周期性和稳定性
- 验证定时器行为
- 排查间歇性故障

---

## 信号发生器与故障注入

VPLC 提供内置的信号发生器和故障注入功能，帮助你在没有真实传感器的情况下测试程序。

### 信号发生器

在 `.vplc.json` 的 `simulation.signals` 中配置：

```json
{
  "simulation": {
    "signals": [
      {
        "channel": "%IX0.0",
        "generator": "pulse",
        "onMs": 1000,
        "offMs": 1000
      },
      {
        "channel": "%IW0",
        "generator": "sine",
        "amplitude": 10000,
        "offset": 15000,
        "periodMs": 5000,
        "noiseLevel": 200
      },
      {
        "channel": "%IW1",
        "generator": "ramp",
        "amplitude": 20000,
        "offset": 5000,
        "periodMs": 8000
      },
      {
        "channel": "%IW2",
        "generator": "square",
        "amplitude": 8000,
        "offset": 12000,
        "periodMs": 3000
      },
      {
        "channel": "%IW3",
        "generator": "random",
        "amplitude": 5000,
        "offset": 10000
      }
    ]
  }
}
```

可用的信号类型：

| 类型 | 说明 | 参数 |
|------|------|------|
| `pulse` | 脉冲信号（布尔量） | `onMs`, `offMs` |
| `sine` | 正弦波 | `amplitude`, `offset`, `periodMs`, `noiseLevel` |
| `square` | 方波 | `amplitude`, `offset`, `periodMs` |
| `sawtooth` | 锯齿波 | `amplitude`, `offset`, `periodMs` |
| `ramp` | 斜坡信号 | `amplitude`, `offset`, `periodMs` |
| `random` | 随机信号 | `amplitude`, `offset` |

### 故障注入

VPLC 的 `FaultInjector` 可以模拟各种 I/O 故障场景：

- **断线**：输入通道固定为 0
- **短路**：输入通道固定为满量程
- **跳变**：输入值突然变化
- **噪声**：在正常信号上叠加随机噪声

这些功能帮助你验证程序的容错处理逻辑。

---

## 常见问题

### Q: VPLC 启动失败？

**A**: 检查以下几项：
1. 确认 `iec-st.vplcPath` 指向正确的二进制文件
2. 检查端口冲突：WebSocket 端口（默认 8090）和 Modbus 端口（默认 502）是否被占用
3. 查看 VS Code 输出面板中的 VPLC 日志

### Q: 调试时断点不生效？

**A**: 确保：
1. `launch.json` 中的 `program` 路径正确
2. 断点设置在可执行行上（不是注释或变量声明行）
3. 编译时启用了调试信息（`iec-st.buildDebug` 设为 `true`）

### Q: Monitor 面板不显示实时值？

**A**: 确保：
1. VPLC 或仿真器正在运行
2. 程序已加载并处于 Running 状态
3. 检查 WebSocket 连接是否正常

### Q: 如何调试多文件项目？

**A**: 在 `launch.json` 中将 `program` 设置为主程序文件即可。调试器会自动加载所有相关文件。你可以在任何项目文件中设置断点。

### Q: 强制表中的值在停止调试后会保持吗？

**A**: 不会。强制值仅在当前调试/仿真会话中有效。VPLC 停止或重置后，所有强制值会被清除。

---

**上一步**：[第一个 PLC 项目](第一个-PLC-项目.md)
**下一步**：[高级开发](高级开发.md)
