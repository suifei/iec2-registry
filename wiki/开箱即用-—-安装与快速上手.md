# 开箱即用 — 安装与快速上手

本教程指导你安装 IECC2 PLC 开发环境，从 VS Code 扩展安装到创建第一个 Demo 工程，全程无需手动配置工具链。

## 目录

- [前置要求](#前置要求)
- [安装 VS Code 扩展](#安装-vs-code-扩展)
- [安装验证](#安装验证)
- [创建第一个 Demo 工程](#创建第一个-demo-工程)
- [界面总览](#界面总览)
- [可选：高级配置](#可选高级配置)
- [跨平台支持](#跨平台支持)
- [常见问题](#常见问题)

---

## 前置要求

| 工具 | 要求 | 说明 |
|------|------|------|
| VS Code | 1.80+ | 从 [code.visualstudio.com](https://code.visualstudio.com) 下载 |
| GCC | 可选 | 若需将生成的 C 代码编译为可执行文件 |

**无需安装**：Go、Java、Node.js、ANTLR4 — 这些是工具链开发者才需要的。

---

## 安装 VS Code 扩展

### 方式 A：扩展市场安装（推荐）

1. 打开 VS Code
2. 点击左侧 **扩展** 图标（或按 `Ctrl+Shift+X` / `Cmd+Shift+X`）
3. 搜索 **"IEC 61131-3 PLC IDE"**
4. 点击 **安装**

### 方式 B：从 .vsix 文件安装（离线环境）

如果你的开发机无法联网，可以使用离线安装：

1. 从发布页面下载 `.vsix` 文件
2. 在 VS Code 中按 `Ctrl+Shift+P`（macOS: `Cmd+Shift+P`）打开命令面板
3. 输入并选择 **"Extensions: Install from VSIX..."**
4. 选择下载的 `.vsix` 文件

### 工具链自动内置

扩展安装完成后，以下工具链**自动内置**在扩展包内，无需单独安装或配置 PATH：

| 工具 | 用途 |
|------|------|
| `iecc` | IEC 61131-3 编译器（ST/IL/SFC → C/LLVM/WASM） |
| `iec-lsp` | 语言服务器（智能提示、错误诊断、悬停信息） |
| `iec-dap` | 调试适配器（断点、单步、变量查看） |
| `iec-vplc` | 虚拟 PLC（仿真执行、I/O 模拟） |
| `iec-sim` | 仿真器（IR 解释执行、WebSocket 监控） |

扩展会根据你的操作系统（Windows/macOS/Linux）和 CPU 架构（x64/ARM64）自动选择正确的二进制文件。

---

## 安装验证

安装完成后，通过以下方式验证扩展是否正常工作：

### 1. 检查侧边栏

左侧活动栏应出现 **IEC Project** 图标（PLC 控制器样式图标）。点击后可看到两个视图：

- **IEC Project** — 项目结构树（POU、DUT、GVL、Interface 等）
- **Resources** — 资源树（设备、I/O、任务、库、网关、VPLC）

### 2. 检查状态栏

VS Code 底部状态栏应显示以下状态项：

- **IEC PLC** — 当前设备/连接状态
- **VPLC** — 虚拟 PLC 状态（启动/停止）
- **Gateway** — 网关连接状态
- **Build** — 构建状态

### 3. 验证语法高亮

1. 新建一个文件，保存为 `test.st`
2. 输入以下内容：

```iec
PROGRAM Test
VAR
    counter : INT := 0;
END_VAR
    counter := counter + 1;
END_PROGRAM
```

3. 你应该看到：
   - 关键字（`PROGRAM`、`VAR`、`INT`、`END_PROGRAM`）高亮显示
   - 鼠标悬停在 `INT` 上显示类型信息
   - 输入时出现代码补全建议

如果以上三项都正常，说明扩展已成功安装。

---

## 创建第一个 Demo 工程

IECC2 提供了一键创建完整演示工程的功能：

1. 按 `Ctrl+Shift+P`（macOS: `Cmd+Shift+P`）打开命令面板
2. 输入 **"IEC: Create Demo Project"**
3. 选择目标文件夹
4. 工程自动创建，包含以下文件：

| 文件 | 说明 |
|------|------|
| `MainProgram.st` | 主程序 — 调度所有功能块 |
| `PID_Controller.st` | PID 控制功能块 |
| `MotorControl.st` | 电机控制功能块（状态机） |
| `AlarmHandler.st` | 报警处理功能块 |
| `GlobalVars.st` | 全局变量声明 |
| `DataTypes.st` | 用户自定义类型（ENUM、STRUCT） |
| `Utilities.st` | 辅助函数（缩放、钳位、死区） |
| `MotorLogic.fbd.json` | FBD 示例：电机启停逻辑 |
| `SafetyLogic.ld.json` | LD 示例：急停安全回路 |
| `TrafficLight.sfc.json` | SFC 示例：交通灯控制 |
| `Dashboard.hmi.json` | HMI 示例：电机控制面板 |

创建完成后，VS Code 会自动打开该工程，侧边栏 IEC Project 树中可以看到完整的项目结构。

---

## 界面总览

IECC2 的 IDE 界面对标 CODESYS，主要分为以下区域：

```
┌─────────────────────────────────────────────────────────┐
│                     菜单栏 / 标题栏                       │
├────────┬────────────────────────────────┬───────────────┤
│        │                                │               │
│  活动栏 │        编辑器区域                │  组件浏览器    │
│        │                                │  (FBD/LD/SFC  │
│ ┌────┐ │  ┌──────────────────────────┐  │   编辑时显示)  │
│ │ IEC│ │  │  ST 文本编辑器             │  │               │
│ │项目│ │  │  或                        │  │               │
│ │ 树 │ │  │  FBD / LD / SFC 图形编辑器 │  │               │
│ │    │ │  │  或                        │  │               │
│ │资源│ │  │  HMI 设计器               │  │               │
│ │ 树 │ │  └──────────────────────────┘  │               │
│ └────┘ │                                │               │
│        │                                │               │
├────────┴────────────────────────────────┴───────────────┤
│  面板区：终端 / 输出 / 问题 / 调试控制台                    │
├─────────────────────────────────────────────────────────┤
│  状态栏：IEC PLC | VPLC | Gateway | Build               │
└─────────────────────────────────────────────────────────┘
```

### 侧边栏 — IEC Project 树

类似 CODESYS 的设备树，按类型组织你的项目资源：

- **Programs** — 程序（PROGRAM）
- **Function Blocks** — 功能块（FUNCTION_BLOCK）
- **Functions** — 函数（FUNCTION）
- **Data Types** — 用户类型（STRUCT、ENUM）
- **Global Variables** — 全局变量列表（VAR_GLOBAL）
- **Interfaces** — 接口定义
- **Tasks** — 任务配置
- **Libraries** — 引用的库
- **Devices** — 目标设备

### 侧边栏 — Resources 树

管理运行时资源：

- **Devices** — 设备选择与 I/O 配置
- **Tasks** — 任务调度配置
- **Libraries** — 库管理器
- **Gateway** — 网关连接
- **VPLC** — 虚拟 PLC 管理

### 编辑器区域

根据文件类型自动选择编辑器：

| 文件类型 | 编辑器 |
|----------|--------|
| `.st` | ST 文本编辑器（语法高亮 + LSP 智能提示） |
| `.fbd.json` | FBD 图形编辑器（功能块图） |
| `.ld.json` | LD 图形编辑器（梯形图） |
| `.sfc.json` | SFC 图形编辑器（顺序功能图） |
| `.hmi.json` | HMI 设计器（人机界面） |

### 常用命令

按 `Ctrl+Shift+P` 打开命令面板，输入 "IEC" 可以看到所有可用命令：

| 命令 | 说明 |
|------|------|
| `IEC: Build All` | 编译整个项目 |
| `IEC: New POU` | 新建程序组织单元 |
| `IEC: New Data Type` | 新建用户类型 |
| `IEC: New Global Variable List` | 新建全局变量列表 |
| `IEC: Open Variable Table` | 打开变量表 |
| `IEC: Open Monitor` | 打开在线监控 |
| `IEC: Open HMI Designer` | 打开 HMI 设计器 |
| `IEC: Open Library Manager` | 打开库管理器 |
| `IEC: Select Device` | 选择目标设备 |
| `IEC: Deploy` | 部署到目标设备 |
| `IEC: VPLC Dashboard` | 打开 VPLC 仪表盘 |
| `IEC: Create Demo Project` | 创建演示工程 |

---

## 可选：高级配置

在大多数情况下，你不需要修改任何设置。以下配置项仅在自定义部署或使用外部工具链时需要：

打开 VS Code 设置（`Ctrl+,`），搜索 "iec-st"：

| 设置项 | 默认值 | 说明 |
|--------|--------|------|
| `iec-st.compilerPath` | `iecc` | 编译器路径（默认使用内置） |
| `iec-st.lspPath` | `iec-lsp` | LSP 服务器路径 |
| `iec-st.dapPath` | `iec-dap` | 调试适配器路径 |
| `iec-st.vplcPath` | `iec-vplc` | VPLC 路径 |
| `iec-st.simPath` | `iec-sim` | 仿真器路径 |
| `iec-st.vplcAutoStart` | `true` | 是否自动启动 VPLC |
| `iec-st.vplcWSPort` | `8090` | VPLC WebSocket 端口 |
| `iec-st.gatewayPath` | `iec-gateway` | 网关路径 |
| `iec-st.buildBackend` | `c` | 编译后端（c/llvm/wasm） |
| `iec-st.buildOptimization` | `0` | 优化级别（0/1/2） |
| `iec-st.buildDebug` | `true` | 生成调试信息 |
| `iec-st.buildParallel` | `4` | 并行编译线程数 |
| `iec-st.targetDevice` | `linux-x86_64` | 目标设备 |

---

## 跨平台支持

IECC2 支持以下操作系统和架构：

| 操作系统 | 架构 | 状态 |
|----------|------|------|
| Windows | x64 | 支持 |
| macOS | x64 (Intel) | 支持 |
| macOS | ARM64 (Apple Silicon) | 支持 |
| Linux | x64 | 支持 |
| Linux | ARM64 | 支持 |

扩展会根据 `process.platform` 和 `process.arch` 自动选择 `bin/<platform>/` 下对应的二进制文件。

---

## 常见问题

### Q: 安装扩展后侧边栏没有出现 IEC Project 图标？

**A**: 确保扩展已正确安装并启用。尝试以下步骤：
1. 按 `Ctrl+Shift+P` → 输入 "Developer: Reload Window" 重新加载窗口
2. 检查扩展列表中 "IEC 61131-3 PLC IDE" 是否显示为已启用
3. 打开或创建一个 `.st` 文件，扩展会在检测到 IEC 文件时自动激活

### Q: 编译时提示找不到 iecc？

**A**: 通常说明内置的二进制文件未正确解包。尝试：
1. 卸载并重新安装扩展
2. 检查扩展安装目录下是否存在 `bin/` 文件夹
3. 如需使用外部编译器，在设置中指定 `iec-st.compilerPath` 的完整路径

### Q: LSP 智能提示不工作？

**A**: 检查以下几项：
1. 查看 VS Code 输出面板（Output），选择 "IEC Language Server" 通道，检查错误日志
2. 确认文件扩展名为 `.st`（大小写敏感）
3. 尝试重新加载窗口

### Q: 如何在离线环境中使用？

**A**: IECC2 完全支持离线使用。所有工具链二进制都内置在扩展包中。只需通过 `.vsix` 文件离线安装扩展即可。

---

**下一步**：[第一个 PLC 项目](第一个-PLC-项目.md)
